---
- hosts: localhost
  gather_facts: false
  vars_files:
    - config.yml
  tasks:
    - name: Enable Homebrew bundle tap
      homebrew_tap: name="homebrew/bundle"

    - name: Check if Brewfile contains updates
      shell: brew bundle check --file="Brewfile"
      register: bundle_check_result
      ignore_errors: true

    - name: Install apps using Brewfile
      shell: brew bundle install --file="Brewfile"
      when: bundle_check_result|failed

    - name: Check codesign certificate
      command: security find-certificate -c chunkwm-khd-cert
      register: certificate_facts
      ignore_errors: true
      changed_when: false
    
    - name: Verify chunkwm signature
      command: codesign -v /usr/local/opt/chunkwm/bin/chunkwm
      register: verification_chunkwm
      ignore_errors: true
      changed_when: false
  
    - name: Verify khd signature
      command: codesign -v /usr/local/opt/khd/bin/khd
      register: verification_khd
      ignore_errors: true
      changed_when: false

    - name: Sign chunkwm
      command: codesign -fs "chunkwm-khd-cert" /usr/local/opt/chunkwm/bin/chunkwm
      when: not certificate_facts|failed and verification_chunkwm|failed
    
    - name: Sign khd
      command: codesign -fs "chunkwm-khd-cert" /usr/local/opt/khd/bin/khd
      when: not certificate_facts|failed and verification_khd|failed

    - name: Install packages from pip
      pip: name="{{ packages.pip|join(' ') }}" state=latest executable=pip3 extra_args="--user"
      environment:
        PIP_REQUIRE_VIRTUALENV: ""

    - name: Install swiss keyboard layouts
      file: src= "files/{{ item }}" dest="~/Library/Keyboard Layouts/{{ item }}"
      with_items:
        - "LogitechSwissGerman.icns"
        - "LogitechSwissGerman.keylayout"
  
    - name: Install dotfiles
      git: repo="{{ system.dotfiles_url }}" dest="$HOME/.dotfiles" update=false
    
    - name: Init dotfiles
      shell: cd "$HOME/.dotfiles/" && ./init.sh

    - name: Set zsh as default shell
      user: shell="/bin/zsh" name="{{ system.username }}"
      become: true
      become_user: root
    
    - name: Setup timezone
      command: systemsetup -f -settimezone "{{ system.time.zone }}"
      become: true
      become_user: root
      
    - name: Enable ntp sync
      command: systemsetup -f -setusingnetworktime on
      become: true
      become_user: root
    
    - name: Setup ntp server
      command: "systemsetup -f -setnetworktimeserver '{{ system.time.server|default('ch.pool.ntp.org') }}'"
      become: true
      become_user: root
    
    - name: Disable wake on lan
      command: systemsetup -f -setwakeonnetworkaccess off
      become: true
      become_user: root

    - name: Disable system reboot after freeze
      command: systemsetup -f -setrestartfreeze off
      become: true
      become_user: root
  
    - name: Disable remote login
      command: systemsetup -f -setremotelogin off
      become: true
      become_user: root
    
    - name: Disable remote apple events
      command: systemsetup -f -setremoteappleevents off
      become: true
      become_user: root

    - name: Setup Hostname
      command: >
            systemsetup -setcomputername "{{ system.hostname }}";
            scutil --set ComputerName "{{ system.hostname }}";
            scutil --set HostName "{{ system.hostname }}";
            scutil --set LocalHostName "{{ system.hostname }}";
            defaults write /Library/Preferences/SystemConfiguration/com.apple.smb.server NetBIOSName -string "{{ system.hostname }}"
      become: true
      become_user: root

    - name: Hide apps
      command: "chflags hidden '/Applications/{{ item }}.app'"
      with_items: "{{ apps.disabled }}"
      become: true
      become_user: root

    - name: Disable apps
      file: path="/Applications/{{ item }}.app" mode=0000
      with_items: "{{ apps.disabled }}"
      become: true
      become_user: root
    
    - name: Disable Bootsound
      shell: > 
              nvram SystemAudioVolume=" ";
              nvram SystemAudioVolumeDB=" ";
      become: true
      become_user: root

    - name: Enable homebrew path for gui apps
      command: launchctl config user path '/usr/local/bin:$PATH'
      become: true
      become_user: root

    - name: Set wallpaper
      command: sqlite3 ~/Library/Application\ Support/Dock/desktoppicture.db "update data set value = '{{ system.setup_path }}/files/wallpaper.jpg'"

    - name: Disable time machine backups while backup volume is not available
      shell: hash tmutil &> /dev/null && sudo tmutil disablelocal
      become: true
      become_user: root

    - name: Disable sudden motion sensor
      command: pmset -a sms 0
      become: true
      become_user: root

    - name: Enable firewall
      command: /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
      become: true
      become_user: root
    
    - name: Disable paranoid modus
      command: /usr/libexec/ApplicationFirewall/socketfilterfw --setblockall off
      become: true
      become_user: root
    
    - name: Disable allow signed apps automatically
      command: /usr/libexec/ApplicationFirewall/socketfilterfw --setallowsignedapp off
      become: true
      become_user: root
    
    - name: Enable stealth mode
      command: /usr/libexec/ApplicationFirewall/socketfilterfw --setstealthmode on
      become: true
      become_user: root
    
    - name: Enable logging
      command: >
          /usr/libexec/ApplicationFirewall/socketfilterfw --setloggingmode on
          /usr/libexec/ApplicationFirewall/socketfilterfw --setloggingopt throttled
      become: true
      become_user: root

    - name: Disable root user
      command: dsenableroot -d

    - name: Set default apps
      command: "duti -s {{ item.app }} {{ item.ext }} all"
      with_items:
        # Set vscode as default for text files
        - { app: "com.microsoft.VSCode", ext: "public.plain-text" }
        # Set vscode as default for common files
        - { app: "com.microsoft.VSCode", ext: "md" }
        - { app: "com.microsoft.VSCode", ext: "cfg" }
        - { app: "com.microsoft.VSCode", ext: "ini" }
        - { app: "com.microsoft.VSCode", ext: "conf" }
        - { app: "com.microsoft.VSCode", ext: "ini" }
        - { app: "com.microsoft.VSCode", ext: "sh" }
        - { app: "com.microsoft.VSCode", ext: "zsh" }
        - { app: "com.microsoft.VSCode", ext: "bat" }
        - { app: "com.microsoft.VSCode", ext: "cmd" }
        - { app: "com.microsoft.VSCode", ext: "xml" }
        # Set vscode as default for Java
        - { app: "com.microsoft.VSCode", ext: "properties" }
        - { app: "com.microsoft.VSCode", ext: "gradle" }
        - { app: "com.microsoft.VSCode", ext: "java" }
        # Set vscode as default for python
        - { app: "com.microsoft.VSCode", ext: "py" }
        - { app: "com.microsoft.VSCode", ext: "yml" }
        - { app: "com.microsoft.VSCode", ext: "yaml" }
        - { app: "com.microsoft.VSCode", ext: "j2" }
        - { app: "com.microsoft.VSCode", ext: "jinja2" }
        # Set vscode as default for C/C++
        - { app: "com.microsoft.VSCode", ext: "cpp" }
        - { app: "com.microsoft.VSCode", ext: "c" }
        - { app: "com.microsoft.VSCode", ext: "h" }
        # Set vscode as default for Posgres
        - { app: "com.microsoft.VSCode", ext: "sql" }
        - { app: "com.microsoft.VSCode", ext: "ddl" }
        - { app: "com.microsoft.VSCode", ext: "dml" }
        - { app: "com.microsoft.VSCode", ext: "pgsql" }
        # Set vlc as default for music files
        - { app: "org.videolan.vlc", ext: "mp3" }
        - { app: "org.videolan.vlc", ext: "flac" }
        - { app: "org.videolan.vlc", ext: "aac" }
        - { app: "org.videolan.vlc", ext: "wma" }
        - { app: "org.videolan.vlc", ext: "ogg" }
        # Set vlc as default for video files
        - { app: "org.videolan.vlc", ext: "mpg" }
        - { app: "org.videolan.vlc", ext: "mkv" }
        - { app: "org.videolan.vlc", ext: "mp4" }
        - { app: "org.videolan.vlc", ext: "wmv" }
        - { app: "org.videolan.vlc", ext: "m4a" }

    - name: Set timemachine backup interval to 24h
      osx_defaults: domain="/System/Library/LaunchDaemons/com.apple.backupd-auto" key=StartInterval state=present type=int value=86400
      become: yes
      become_user: root

    - name: Disable time machine prompt for new disks as backup volume
      osx_defaults: domain="/Library/Preferences/com.apple.TimeMachine" key=DoNotOfferNewDisksForBackup state=present type=bool value=true
      become: true
      become_user: root
  
    - name: Disable time machine while on battery
      osx_defaults: domain="/Library/Preferences/com.apple.TimeMachine" key=RequiresACPower state=present type=bool value=false
      become: true
      become_user: root
  
    - name: Auto clear trash every 30 days
      osx_defaults: domain="com.apple.finder" key=FXRemoveOldTrashItems state=present type=bool value=true

    - name: Use plain text mode for new textedit documents
      osx_defaults: domain="com.apple.TextEdit" key=RichText state=present type=int value=0

    - name: Open and save files as utf8 in textedit
      osx_defaults: domain="com.apple.TextEdit" key="{{ item }}" state=present type=int value=5
      with_items:
        - PlainTextEncoding
        - PlainTextEncodingForWrite
    
    - name: Fix key repeat for vscode vim plugin
      osx_defaults: domain="com.microsoft.VSCode" key=ApplePressAndHoldEnabled state=present type=bool value=false
    
    - name: Disable press-and-hold for special keys
      osx_defaults: domain="NSGlobalDomain" key=ApplePressAndHoldEnabled state=present type=bool value=false
    
    - name: Enable auto rearrange spaces based on recent use
      osx_defaults: domain="com.apple.dock" key="mru-spaces" state=present type=bool value=true
    
    - name: Enable icon bouncing should when respective application demands attention
      osx_defaults: domain="com.apple.dock" key="no-bouncing" state=present type=bool value=true
    
    - name: Disable touchpad or mouse scroll wheel on dock items
      osx_defaults: domain="com.apple.dock" key="scroll-to-open" state=present type=bool value=false
    
    - name: Enable effect on app when app is hidden and running in background
      osx_defaults: domain="com.apple.dock" key=showhidden state=present type=bool value=true
    
    - name: Remove persistent icons from dock
      osx_defaults: domain="com.apple.dock" key="persistent-apps" state=absent

    - name: Set icons to optimal size in dock
      osx_defaults: domain="com.apple.dock" key=tilesize state=present type=float value=36

    - name: Enable automatically hiding and showing the dock
      osx_defaults: domain="com.apple.dock" key=autohide state=present type=bool value=true

    - name: Disable mission control and spaces
      osx_defaults: domain="com.apple.dock" key="mcx-expose-disabled" state=present type=bool value=true

    - name: Disable mouse hover on dock
      osx_defaults: domain="com.apple.dock" key="mouse-over-hilite-stack" state=present type=bool value=false

    - name: Use scale as minimize/maximize window effect
      osx_defaults: domain="com.apple.dock" key=mineffect state=present value=scale

    - name: Disable minimizing windows into their applications icon
      osx_defaults: domain="com.apple.dock" key="minimize-to-application" state=present type=bool value=false

    - name: Disable spring loading (drag and drop) for all dock items
      osx_defaults: domain="com.apple.dock" key="enable-spring-load-actions-on-all-items" state=present type=bool value=true

    - name: Enable indicator lights for open applications in the dock
      osx_defaults: domain="com.apple.dock" key="show-process-indicators" state=present type=bool value=true

    - name: Enable animation when opening applications from the dock
      osx_defaults: domain="com.apple.dock" key=launchanim state=present type=bool value=true

    - name: Speed up Mission Control animations
      osx_defaults: domain="com.apple.dock" key="expose-animation-duration" state=present type=float value=0.1

    - name: Disable dashboard space in mission control
      osx_defaults: domain="com.apple.dock" key="dashboard-in-overlay" state=present type=bool value=true

    - name: Make dock more transparent
      osx_defaults: domain="com.apple.dock" key="hide-mirror" state=present type=bool value=true

    - name: Disable all hot corners
      osx_defaults: domain="com.apple.dock" key="{{ item }}" state=present type=int value=0
      with_items:
        - "wvous-tl-corner"
        - "wvous-tl-modifier"
        - "wvous-tr-corner"
        - "wvous-tr-modifier"
        - "wvous-bl-corner"
        - "wvous-bl-modifier"

    - name: Reset launchpad layout
      osx_defaults: domain="com.apple.dock" key=ResetLaunchPad state=present type=bool value=true

    - name: Expand save panel by default
      osx_defaults: key=NSNavPanelExpandedStateForSaveMode state=present type=bool value=true

    - name: Expand print panel by default
      osx_defaults: key="{{ item }}" state=present type=bool value=true
      with_items:
        - "PMPrintingExpandedStateForPrint2"
        - "PMPrintingExpandedStateForPrint"

    - name: Increase number of recent places
      osx_defaults: key=NSNavRecentPlacesLimit state=present type=int value=10

    - name: Disable spotlights indexing for new volumes
      osx_defaults:
        array_add: true
        domain: "/.Spotlight-V100/VolumeConfiguration"
        key: Exclusions
        state: present
        type: array
        value:
        - "/Volumes"
      become: true
      become_user: root

    - name: Enable quitting printer app automatically once finished
      osx_defaults: domain="com.apple.print.PrintingPrefs" key="Quit When Finished" state=present type=bool value=true

    - name: Disable saving files to icloud
      osx_defaults: key=NSDocumentSaveNewDocumentsToCloud state=present type=bool value=false

    - name: Enable better sound qualitiy for bluetooth headphones
      osx_defaults: domain="com.apple.BluetoothAudioAgent" key="Apple Bitpool Min (editable)" state=present type=int value=40

    - name: Set very fast key repeat rate
      osx_defaults: key="KeyRepeat" state=present type=int value=2

    - name: Disable automatic spelling correction
      osx_defaults: domain="" key=NSAutomaticSpellingCorrectionEnabled state=present type=bool value=false

    - name: Disable all desktop icons
      osx_defaults: domain="com.apple.finder" key="{{ item }}" state=present type=bool value=false
      with_items:
        - "ShowExternalHardDrivesOnDesktop"
        - "ShowHardDrivesOnDesktop"
        - "ShowMountedServersOnDesktop"
        - "ShowRemovableMediaOnDesktop"
        - "CreateDesktop"

    - name: Show filename extensions in finder
      osx_defaults: key=AppleShowAllExtensions state=present type=bool value=true

    - name: Disable creation of .DS_STORE files on network
      osx_defaults: domain="com.apple.desktopservices" key=DSDontWriteNetworkStores state=present value=true

    - name: Disable Creation of .DS_STORE files on usb volumes
      osx_defaults: domain="com.apple.desktopservices" key=DSDontWriteUSBStores state=present value=true

    - name: Enable full keyboard access for all controls
      osx_defaults: key="AppleKeyboardUIMode" state=present type=int value=3

    - name: Disable dashboard
      osx_defaults: domain="com.apple.dashboard" key="{{ item.key }}" state=present type="{{ item.type }}" value="{{ item.val }}"
      with_items:
        - { key: "dashboard-enabled-state", type: int, val: 1 }
        - { key: mcx-disabled, type: bool, val: true }

    - name: Enable to always show scrollbars
      osx_defaults: key="AppleShowScrollBars" state=present value=Always

    - name: Enable to automatically illuminate built-in keyboard in low light
      osx_defaults: domain="com.apple.BezelServices" key="kDim" state=present type=bool value=true
    
    - name: Turn off keyboard illumination when computer is not used for 5 minutes
      osx_defaults: domain="com.apple.BezelServices" key="kDimTime" state=present type=int value=300
    
    - name: Show hostname when clicking the clock in the login window
      osx_defaults: domain="/Library/Preferences/com.apple.loginwindow" key="AdminHostInfo" state=present value=HostName
      become: true
      become_user: root
    
    - name: Check for software updates daily
      osx_defaults: domain="com.apple.SoftwareUpdate" key="ScheduleFrequency" state=present type=int value=1

    - name: Set trackpad options and gestures
      osx_defaults: domain="com.apple.driver.AppleBluetoothMultitouch.trackpad" key="{{ item.key }}" state=present type=int value={{ item.val }}
      with_items:
        # Enable tap to click
        - { key: Clicking, val: 1}
        # Set scroll direction to natural
        - { key: TrackpadScroll, val: 1}
        # Enable smart zoom with double tap
        - { key: TrackpadTwoFingerDoubleTapGesture, val: 1}
        # Enable rotate with two fingers
        - { key: TrackpadRotate, val: 1}
        # Set vertical two finger swipe to swipe between pages
        - { key: TrackpadTwoFingerDoubleTapGesture, val: 1}
        # Set vertical three finger swipe to swipe between full-screen apps
        - { key: TrackpadThreeFingerVertSwipeGesture, val: 2}
        # Set horizontal three finger swipe to show mission control
        - { key: TrackpadThreeFingerHorizSwipeGesture, val: 2}
        # Disable all other gestures
        - { key: DragLock, val: 0}
        - { key: Dragging, val: 0}
        - { key: TrackpadCornerSecondaryClick, val: 0}
        - { key: TrackpadFiveFingerPinchGesture, val: 0}
        - { key: TrackpadFourFingerPinchGesture, val: 0}
        - { key: TrackpadThreeFingerDrag, val: 0}
        - { key: TrackpadThreeFingerTapGesture, val: 0}
        - { key: TrackpadTwoFingerFromRightEdgeSwipeGesture, val: 0}
        - { key: USBMouseStopsTrackpad, val: 0}
    
    - name: Require password after screen saver
      osx_defaults: domain="com.apple.screensaver" key=askForPassword state=present type=int value=1
      
    - name: Require password immediately after sleep or screen saver begins
      osx_defaults: domain="com.apple.screensaver" key=askForPasswordDelay state=present type=float value=0.1

    - name: Enable to show status bar in finder
      osx_defaults: domain="com.apple.finder" key=ShowStatusBar state=present type=bool value=true
    
    - name: Use list view in all finder windows by default 
      osx_defaults: domain="com.apple.finder" key=FXPreferredViewStyle state=present value=Nlsv
  
    - name: Disable the warning before emptying the trash
      osx_defaults: domain="com.apple.finder" key=WarnOnEmptyTrash state=present type=bool value=false

    - name: Empty trash securely by default
      osx_defaults: domain="com.apple.finder" key=EmptyTrashSecurely state=present type=bool value=true

    - name: Enable to quit finder via Cmd + Q
      osx_defaults: domain="com.apple.finder" key=QuitMenuItem state=present type=bool value=true
      
    - name: Set desktop as default location for new finder windows
      osx_defaults: domain="com.apple.finder" key="{{ item.key }}" state=present value="{{ item.var }}"
      with_items:
        - { key: "NewWindowTarget", var: "PfDe" }
        - { key: "NewWindowTargetPath", var: "file://${HOME}/Desktop/" }
      
    - name: Disable path bar in finder
      osx_defaults: domain="com.apple.finder" key="ShowPathbar" state=present type=bool value=false
      
    - name: Enable text selection in quick look
      osx_defaults: domain="com.apple.finder" key=QLEnableTextSelection state=present type=bool value=true
      
    - name: Display full posix path in finder
      osx_defaults: domain="om.apple.finder" key="_FXShowPosixPathInTitle" state=present type=bool value=true
      
    - name: Set default search to current folder
      osx_defaults: domain="com.apple.finder" key=FXDefaultSearchScope state=present value=SCcf
    
    - name: Disable warning when changing a file extension
      osx_defaults: domain="com.apple.finder" key=FXEnableExtensionChangeWarning state=present type=bool value=false
    
    - name: Disable airdrop
      osx_defaults: domain="com.apple.NetworkBrowser" key=DisableAirDrop state=present type=bool value=true
    
    - name: Expand the panes by default
      osx_defaults: domain="com.apple.finder.FXInfoPanesExpanded" key="{{ item }}" state=present type=bool value=true
      with_items:
        - "General"
        - "OpenWith"
        - "Privileges"

    - name: Enable transparency in menu bar
      osx_defaults: key=AppleEnableMenuBarTransparency state=present type=bool value=true
         
    - name: Set highlight color to graphite
      osx_defaults: key=AppleHighlightColor state=present value="0.847059 0.847059 0.862745"
        
    - name: Set sidebar icon size to small
      osx_defaults: key=NSTableViewDefaultSizeMode state=present type=int value=1
    
    - name: Set better window resize speed for cocoa applications
      osx_defaults: key=NSWindowResizeTime state=present type=float value=0.1
    
    - name: Disable to automatically resume last running apps after a reboot
      osx_defaults: key=NSQuitAlwaysKeepsWindows state=present type=bool value=false
    
    - name: Disable the crash reporter
      osx_defaults: domain="com.apple.CrashReporter" key=DialogType state=present value=none
    
    - name: Disable smart quotes
      osx_defaults: key=NSAutomaticQuoteSubstitutionEnabled state=present type=bool value=false
    
    - name: Set screenshot location
      osx_defaults: domain="com.apple.screencapture" key="location" state=present value="${HOME}/Desktop"
    
    - name: Set screenshot image type
      osx_defaults: domain="com.apple.screencapture" key=type state=present value=png
    
    - name: Disable shadow in screenshots
      osx_defaults: domain="com.apple.screencapture" key="disable-shadow" state=present type=bool value=true

    - name: Enable subpixel font rendering on non-apple lcds
      osx_defaults: key=AppleFontSmoothing state=present type=int value=2

    - name: Enable spring loading for directories
      osx_defaults: key="com.apple.springing.enable" state=present type=bool value=true

    - name: Set delay for spring loading
      osx_defaults: key="com.apple.springing.delay" state=present type=float value=0.2

    - name: Disable airdrop over ethernet
      osx_defaults: domain="com.apple.NetworkBrowser" key="BrowseAllInterfaces" state=present type=bool value=false

    - name: Show the main window when launching activity monitor
      osx_defaults: domain="com.apple.ActivityMonitor" key=OpenMainWindow state=present type=bool value=true

    - name: Show all processes in activity monitor
      osx_defaults: domain="com.apple.ActivityMonitor" key=ShowCategory state=present type=int value=0

    - name: Sort activity monitor cpu usage
      osx_defaults: domain="com.apple.ActivityMonitor" key=SortColumn state=present value=CPUUsage

    - name: Sort activity monitor ascending
      osx_defaults: domain="com.apple.ActivityMonitor" key=SortDirection state=present type=int value=0

    - name: Disable infrared receiver
      osx_defaults: domain="/Library/Preferences/com.apple.driver.AppleIRController" key=DeviceEnabled state=present type=int value=1

    - name: Disable Autoplay in quicktime
      osx_defaults: domain="com.apple.QuickTimePlayerX" key=MGPlayMovieOnOpen state=present type=int value=0

    - name:  Disable bonjour service
      osx_defaults:
        array_add: true
        domain: "/System/Library/LaunchDaemons/com.apple.mDNSResponder.plist"
        key: "ProgramArguments"
        state: present
        type: array 
        value:
          - "-NoMulticastAdvertisements"
      become: true
      become_user: root